===================================
OASEを設定する際の事前設計について
===================================

アクション実行の条件の整理
============================

| では具体的な設定について考えてみましょう。

| アクションが実行される状況を見ると、

 | インスタンスが何台稼働している状況で、どのような通知が来たか

| という形で条件づけられているのがわかります。

| つまり、ルールを設定する際の条件となるフィルターは、

 | インスタンスが何台稼働しているか
 | どのような通知が来たか

| というものがあればよいことになります。

| ただ、通知が来た時に2つ以上のアクションを行う必要があるパターンもあるので、注意が必要です。

| 例えば、インスタンスが1台稼働している状況で、閾値100リクエスト/minを超過したというリクエスト数超過通知が来たら、

  | インスタンス1台稼働 + 閾値100リクエスト/min超過  ⇒  インスタンス2台にスケールアウト
  | インスタンス2台稼働 + 閾値100リクエスト/min超過  ⇒  インスタンス3台にスケールアウト

| というスケールアウトをするというアクションが2回実行される必要があります。

| つまり、

 | 通知が来たことにより実行されるスケールアウト
 | スケールアウトしたあとの状況でもリクエスト数がいまだ閾値を超えている場合のスケールアウト

| というアクションが行われるようにルールを設定してあげればよいことになります。

| 以上のように、それぞれのアクションが実行される条件は、

 | ①  通知内容  +  通知が来る前の状況
 | ②  通知内容  +  ①のアクションが実行された後の状況
 
| で決まることになります。

条件の実現方法と注意点
===========================

| 各状況の把握は、インスタンスが何台稼働しているか、というフィルターで把握可能です。
| 通知内容の把握は、どのような通知が来たか、というフィルターで把握可能です。

| これらのフィルターを条件としたルールを作成しますが、①のルールで通知メールのイベントがフィルタリングされると、
| ②で改めて同じイベントをフィルタリングすることはできません。

| そのため、②で通知内容を参照するには、:doc:`OASE_advanced_sorry-switch-back` で用いた「元イベントのラベル継承」の設定を行う必要があります。
| この設定により、①の結論イベントに元となった通知メールのイベントからラベルを継承することができ、通知内容を②でも把握可能となります。

| ここで注意すべきは、:doc:`OASE_advanced_sorry-switch-back` で見たように「元イベントのラベル継承」の設定をすることでループする場合があるという点です。
| 今回の6パターンの中では、

- パターン3 インスタンス3台のとき、リクエスト数超過通知:150

| のルールで「元イベントのラベル継承」の設定をするとループが発生してしまいます。

| このパターンでは、アクションの実行結果によってこれまでの稼働しているインスタンス数を示すラベルを更新せず、
| 新しい「Sorry画面への切り替え」を示すラベルが追加されるからです。
  
| そのため、結論イベントに付与されるラベルは、元イベントに付与されていた、

 | 稼働しているインスタンス数が3台であることを示すラベル
 | リクエスト数超過通知:150という通知内容を示すラベル

| と、新たに追加される

 | 「Sorry画面への切り替え」を示すラベル

| となり、元イベントから継承されたラベルをもとに、

| このルールの条件となっているフィルターに再度フィルタリングされてしまう

| という意図しないループが無限に発生してしまいます。

| それ以外のパターンのときは、アクション実行後稼働しているインスタンス数が変化するため、そのルールの条件としているインスタンス数とは異なる形になりループはしません。

.. note::
   | 具体的な設定内容については、:doc:`OASE_master_setting` で確認してみましょう。

| そのため、

- パターン3 インスタンス3台のとき、リクエスト数超過通知:150
  
| のルールでは、「元イベントのラベル継承」の設定は行わず、Sorry画面への切り替えを示す結論イベントのラベルを付与する形にします。

| またこの設定に合わせて、

- パターン4 インスタンス3台のとき、リクエスト数回復通知:50/100/150
   
| の通知が来る前の状況把握は、「インスタンス3台のとき」ではなく、「Sorry画面への切り替えが行われているとき」を条件とするように設定しましょう。

| ここまで整理できたら、具体的なOASEの設定を :doc:`OASE_master_setting` でみていきましょう。
