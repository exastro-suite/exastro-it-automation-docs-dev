===================
イベント連携 - OASE
===================

| 本シナリオでは、簡単な例として、以下のようなリクエスト数に応じた運用保守を題材に OASE の基本操作を学習します。
| 本シナリオでは、リクエスト数に応じた運用保守を行うことを題材として扱いますが、様々なイベントをもとに運用保守することも可能で、本シナリオはあくまで数ある運用保守パターンの一例であることを理解してください。

| 今回は、以下のような構成を想定しています。

1. インスタンス1台につき、50リクエスト/minを閾値とする。
2. 通常は1台稼働である。
3. Webサーバ前のLBを監視し、Webサーバへの総リクエスト数に関してメールで通知する。
4. リクエスト数が閾値に達したらスケールアウトをする。
5. スケールアウトの上限は3台とし、それ以上のリクエスト数があった場合は、Sorry画面へ切り替える。
6. リクエスト数が閾値内に回復したら、切り戻しを行う。

| リクエスト数に関するメール通知をイベントとして、イベント発生に合わせて4.と5.、6.の保守作業を行うよう、OASEの設定を行います。

| またOASEでは、以下のような流れで自動化を実現します。

1. イベントを外部サービスから収集する
2. 収集したイベントの属性に合わせてラベルを付与する
3. ラベルが条件に合ったときに、保守作業を自動的に実行する

| リクエスト数を通知するメールの内容は以下のものを想定しています。

.. list-table:: 通知メール一覧
   :widths: 5 10 10
   :header-rows: 1

   * - 通知内容
     - リクエスト数超過
     - リクエスト数閾値内回復
   * - :kbd:`件名`
     - :kbd:`[alert] Requests: Threshold reached`
     - :kbd:`[info] Requests: Threshold recovery`
   * - :kbd:`本文`
     - | :kbd:`リクエスト数が、閾値を超えました。` 
       | :kbd:`RequestCount > 150`
     - | :kbd:`リクエスト数が、閾値内に回復しました。`
       | :kbd:`RequestCount < 150`
   * - :kbd:`備考`
     - :kbd:`値は、50，100，150のどれか`
     - :kbd:`値は、50，100，150のどれか`

| まずは、リクエスト数が閾値を超過した時の対応について学習し、演習問題でリクエスト数が閾値内に回復した時の対応について実際に自分で設定してみましょう。

前提
====

| 本シナリオを操作するに必要となる条件は、下記の通りです。

1. OASEのインストール
2. 作業用ワークスペース
3. メールアカウント
4. 各種Conductor・オペレーション 

.. glossary:: ワークスペース
   システムの構成情報や自動化タスクのための設計情報を中央管理するための作業領域のことです。

.. tip::
   シナリオの展開に合わせて、以下の名称のConductor・オペレーションが必要になります。

.. list-table:: Conductor・オペレーション一覧
   :widths: 150
   :header-rows: 0

   * - インスタンススケールアウト
   * - インスタンススケールイン
   * - Sorry画面切り替え
   * - Sorry画面切り戻し

自動化する作業について
=======================

| 今回のシナリオでは、以下の保守作業を自動的に実行します。

- 作業A インスタンスをスケールアウトする作業
- 作業B Sorry画面へ切り替える作業
- 作業C インスタンスをスケールインする作業
- 作業D Sorry画面から切り戻す作業

シナリオの流れ
================

| OASEの設定は、以下の流れになります。

1. イベント収集設定
   
   | - どの外部サービスからイベントを収集するかを設定

2. ラベルの設定
   
   | - 収集したイベントを特定するために付与するラベルに関する設定

3. OASEエージェントの設定
   
   | - 外部サービスからイベントを収集するOASEエージェントの設定

4. ルールの設定 
   
   | - 収集されたイベントをもとに保守作業を実行するための設定

| それでは、各作業について、具体的にOASEの設定を行っていきましょう。

シナリオ
========

.. .. raw:: html

..    </div>
..    <div id="multiColumnIndex">

.. toctree::
   :maxdepth: 2
   :numbered: 3

   OASE_scenario_scale-out
   OASE_scenario_sorry-switch
   OASE_practice_scale-in
   OASE_answer_scale-in
   OASE_practice_sorry-switch-back
   OASE_answer_sorry-switch-back
   OASE_advanced_sorry-switch-back
   OASE_advanced2_sorry-switch-back
   OASE_advanced3_sorry-switch-back.rst

.. .. raw:: html

..    </div>