
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-144561796-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-144561796-1');
    </script>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <title>1. 高可用性 (HA) &#8212; Documentation  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/option.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/exastro_documents.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/swagger/swagger-ui.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/translations.js"></script>
    <script src="../../_static/jquery-3.6.3.min.js"></script>
    <script src="../../_static/exastro_documents.js"></script>
    <script src="../../_static/swagger/swagger-ui-bundle.js"></script>
    <script src="../../_static/swagger/swagger-ui-standalone-preset.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="インストール" href="../../installation/index.html" />
    <link rel="prev" title="ベストプラクティス" href="index.html" /> 
  </head>
<body id="page" class="ja">


<div id="container">

<div id="header">
  <header class="divInner">
    <!-- Exastro logo -->
    <div id="logo"><a href="https://ita.exastro.org/"><img src="../../_static/img/exastro.svg" alt="Exastro"></a></div>
    <!-- Project name -->
    <div id="projectName"><a href="../../index.html">Documentation</a></div>
    <!-- Heaedr navigation -->
    <div id="headerSearch">
      <form class="search" action="../../search.html" method="get">
        <input type="text" name="q" aria-labelledby="searchlabel">
        <button type="submit" value="検索"><img src="../../_static/img/search.png" alt="検索"></button>
      </form>
    </div>
  </header>
</div><!-- End #header -->


<div id="toolbar">
  <div class="divInner">
    
    <div id="documentVersion">
      <dl>
        <dt>Document version</dt>
        <dd>
          <div>
            <select name="version" onchange="location.href=value;">
              <option value="../../../../ja/2.4/configuration/best_practices/high_availability.html" selected>current</option>
              <option value="../../../../ja/2.4/configuration/best_practices/high_availability.html" selected>2.4(current)</option>
              <option value="../../../../ja/2.3/configuration/best_practices/high_availability.html">2.3</option>
              <option value="../../../../ja/2.2/configuration/best_practices/high_availability.html">2.2</option>
              <option value="../../../../ja/2.1/configuration/best_practices/high_availability.html">2.1</option>
              <option value="../../../../ja/2.0/configuration/best_practices/high_availability.html">2.0</option>
            </select>
          </div>
        </dd>
      </dl>
    </div>

    <div id="documentLanguage">
      <dl>
        <dt>Language</dt>
        <dd>
          <div>
            <select name="lang" onchange="location.href=value;">
              <option value="../../../../ja/2.4/configuration/best_practices/high_availability.html" selected>日本語</option>
              <option value="../../../../en/2.4/configuration/best_practices/high_availability.html">English</option>
            </select>
          </div>
        </dd>
      </dl>
    </div>
    <div id="toolbarNavigation">
      <ul>
        <li class="prev"><a href="index.html" title="前のトピックへ">ベストプラクティス</a></li>
        <li class="next"><a href="../../installation/index.html" title="次のトピックへ">インストール</a></li>
      </ul>
    </div>
  </div>
</div><!-- End #toolbar -->

<div id="sideMenu">

  <div id="menuButton"></div>
  
  <aside class="divInner">
    <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">構成・構築ガイド</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansible/index.html">Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="../terraform/index.html">Terraform</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">ログ</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">ベストプラクティス</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">1. 高可用性 (HA)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">1.1. 目的</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">1.2. 構成図</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">1.3. 対象</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exastro">1.4. Exastroアプリケーション</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.5. ロードバランサー・リバースプロキシ</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id5">1.5.1. 前提条件</a></li>
<li class="toctree-l5"><a class="reference internal" href="#hosts">1.5.2. hostsの定義</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id6">1.5.3. シェル変数設定</a></li>
<li class="toctree-l5"><a class="reference internal" href="#haproxy">1.5.4. haproxyの導入・設定</a></li>
<li class="toctree-l5"><a class="reference internal" href="#keepalived">1.5.5. keepalived の導入</a></li>
<li class="toctree-l5"><a class="reference internal" href="#keepalived-haproxy">1.5.6. アクセス確認(keepalived+haproxy)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#haproxy-ssl">1.5.7. haproxy SSL化</a></li>
<li class="toctree-l5"><a class="reference internal" href="#haproxy-exastro">1.5.8. haproxy（exastro接続）</a></li>
<li class="toctree-l5"><a class="reference internal" href="#exastro-external-url">1.5.9. exastro EXTERNAL_URL設定変更</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#id7">1.6. ストレージ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">インストール</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../learn/index.html">Learn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manuals/index.html">マニュアル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../templates/index.html">テンプレート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">リファレンス</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">貢献</a></li>
</ul>

    <!-- <ul>
      <li class="toctree-l1"><a class="reference internal" href="../../../../genindex.html">索引</a></li>
    </ul> -->
    
  </aside>
</div><!-- End #sideMenu -->


<div id="tableOfContents">
  <div id="tocButton"></div>
  <ul>
<li><a class="reference internal" href="#">1. 高可用性 (HA)</a><ul>
<li><a class="reference internal" href="#id1">1.1. 目的</a></li>
<li><a class="reference internal" href="#id2">1.2. 構成図</a></li>
<li><a class="reference internal" href="#id3">1.3. 対象</a></li>
<li><a class="reference internal" href="#exastro">1.4. Exastroアプリケーション</a></li>
<li><a class="reference internal" href="#id4">1.5. ロードバランサー・リバースプロキシ</a><ul>
<li><a class="reference internal" href="#id5">1.5.1. 前提条件</a></li>
<li><a class="reference internal" href="#hosts">1.5.2. hostsの定義</a></li>
<li><a class="reference internal" href="#id6">1.5.3. シェル変数設定</a></li>
<li><a class="reference internal" href="#haproxy">1.5.4. haproxyの導入・設定</a></li>
<li><a class="reference internal" href="#keepalived">1.5.5. keepalived の導入</a></li>
<li><a class="reference internal" href="#keepalived-haproxy">1.5.6. アクセス確認(keepalived+haproxy)</a></li>
<li><a class="reference internal" href="#haproxy-ssl">1.5.7. haproxy SSL化</a></li>
<li><a class="reference internal" href="#haproxy-exastro">1.5.8. haproxy（exastro接続）</a></li>
<li><a class="reference internal" href="#exastro-external-url">1.5.9. exastro EXTERNAL_URL設定変更</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7">1.6. ストレージ</a></li>
</ul>
</li>
</ul>

</div>


<div id="contents">
<main class="divInner">

 <div id="breadcrumbs">
  <ul>
    <li><a href="../../index.html">HOME</a></li>
    <li><a href="../index.html">構成・構築ガイド</a></li>
    <li><a href="index.html">ベストプラクティス</a></li>
    
    <li><span class="section-number">1. </span>高可用性 (HA)</li>
  </ul>
</div>

<div id="article">
<article class="divInner">
<div class="body" role="main">

  <section id="ha">
<h1><span class="section-number">1. </span>高可用性 (HA)<a class="headerlink" href="#ha" title="この見出しへのパーマリンク">¶</a></h1>
<div class="line-block">
<div class="line">本説明では Exastro システムにおける、高可用性について記載しております。</div>
<div class="line">高可用性の構築にあたり、Kubernetesなどのコンテナオーケストレーションが必要不可欠となっております。</div>
</div>
<section id="id1">
<h2><span class="section-number">1.1. </span>目的<a class="headerlink" href="#id1" title="この見出しへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line">各作業の自動化を進める中で、Exastroシステムを使用するにあたり、システムの可用性が高い（安定した稼働）を求める構成が必要と考えられます。</div>
<div class="line">安定した稼働を実現するには、Kubernetesのコンテナオーケストレーションが必要不可欠となっており</div>
<div class="line">コンテナオーケストレーションによる、ExastroシステムのHA構成の構築は、非常にハードルが高いため、</div>
<div class="line">本書では、その構築を容易に行えるよう、構成概要や構築サンプルを公開しております。</div>
</div>
</section>
<section id="id2">
<h2><span class="section-number">1.2. </span>構成図<a class="headerlink" href="#id2" title="この見出しへのパーマリンク">¶</a></h2>
</section>
<section id="id3">
<h2><span class="section-number">1.3. </span>対象<a class="headerlink" href="#id3" title="この見出しへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line">本説明における、高可用性の範囲は、ロードバランサー・リバースプロキシ、Exastroアプリケーション、ストレージ(永続データ)となります。</div>
<div class="line">※Kubernetesなどのコンテナオーケストレーションの高可用性については、記載しません。</div>
</div>
</section>
<section id="exastro">
<h2><span class="section-number">1.4. </span>Exastroアプリケーション<a class="headerlink" href="#exastro" title="この見出しへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line">Exastroシステムのアプリケーションは、基本的に冗長構成を行うことで、システムの可用性を高くすることができます。</div>
<div class="line">※Exastro IT Automation Ver.2.4.0において、backend処理の一部については、高可用性対応待ちとなっております。</div>
</div>
<div class="line-block">
<div class="line">アプリケーションの高可用性設定につきましては、レプリカ数やPodのAffinity設定で冗長構成ができます。</div>
</div>
</section>
<section id="id4">
<h2><span class="section-number">1.5. </span>ロードバランサー・リバースプロキシ<a class="headerlink" href="#id4" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id5">
<h3><span class="section-number">1.5.1. </span>前提条件<a class="headerlink" href="#id5" title="この見出しへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">以下の例はRHEL8で実施する場合の手順です。</div>
</div>
<table class="docutils align-left" id="id8">
<caption><span class="caption-number">表 1.11 </span><span class="caption-text">ホスト一覧</span><a class="headerlink" href="#id8" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ホスト名</p></th>
<th class="head"><p>IP</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ha-conf-haproxy-vip</p></td>
<td><p>192.168.0.1</p></td>
</tr>
<tr class="row-odd"><td><p>ha-conf-haproxy-01</p></td>
<td><p>192.168.0.2</p></td>
</tr>
<tr class="row-even"><td><p>ha-conf-haproxy-02</p></td>
<td><p>192.168.0.3</p></td>
</tr>
<tr class="row-odd"><td><p>ha-conf-k8s-01</p></td>
<td><p>192.168.0.4</p></td>
</tr>
<tr class="row-even"><td><p>ha-conf-k8s-02</p></td>
<td><p>192.168.0.5</p></td>
</tr>
<tr class="row-odd"><td><p>ha-conf-k8s-03</p></td>
<td><p>192.168.0.6</p></td>
</tr>
</tbody>
</table>
</section>
<section id="hosts">
<h3><span class="section-number">1.5.2. </span>hostsの定義<a class="headerlink" href="#hosts" title="この見出しへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">以下の内容を <strong>ha-conf-haproxy-01</strong> および <strong>ha-conf-haproxy-02</strong> のhostsに追記します。</div>
</div>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-number">リスト 1.1 </span><span class="caption-text">conf:/etc/hosts</span><a class="headerlink" href="#id9" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">192</span>.168.0.2<span class="w">  </span>ha-conf-haproxy-01
<span class="m">192</span>.168.0.3<span class="w">  </span>ha-conf-haproxy-02
<span class="m">192</span>.168.0.1<span class="w">  </span>ha-conf-haproxy-vip
<span class="m">192</span>.168.0.4<span class="w">  </span>ha-conf-k8s-01
<span class="m">192</span>.168.0.5<span class="w">  </span>ha-conf-k8s-02
<span class="m">192</span>.168.0.6<span class="w">  </span>ha-conf-k8s-03
</pre></div>
</div>
</div>
</section>
<section id="id6">
<h3><span class="section-number">1.5.3. </span>シェル変数設定<a class="headerlink" href="#id6" title="この見出しへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">作業の中で各IPアドレスを各所で使用するのでシェル変数に設定します。</div>
</div>
<ul class="simple">
<li><p>ha-conf-haproxy-01 および ha-conf-haproxy-02共通</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">VM1_IP_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.2&quot;</span><span class="w">         </span><span class="c1"># haproxy1号機のIPアドレス</span>
<span class="nv">VM2_IP_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.3&quot;</span><span class="w">        </span><span class="c1"># haproxy2号機のIPアドレス</span>
<span class="nv">VIRTUAL_IP_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.1&quot;</span><span class="w">    </span><span class="c1"># haproxyのVIP</span>
<span class="nv">K8S_NODE1_IP_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.4&quot;</span><span class="w">  </span><span class="c1"># kubernetes node1のIPアドレス</span>
<span class="nv">K8S_NODE2_IP_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.5&quot;</span><span class="w">  </span><span class="c1"># kubernetes node2のIPアドレス</span>
<span class="nv">K8S_NODE3_IP_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.6&quot;</span><span class="w">  </span><span class="c1"># kubernetes node3のIPアドレス</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ha-conf-haproxy-01</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">VM_SELF_IP_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.2&quot;</span><span class="w">     </span><span class="c1"># 自身のIPアドレス</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ha-conf-haproxy-02</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">VM_SELF_IP_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.0.3&quot;</span><span class="w">    </span><span class="c1"># 自身のIPアドレス</span>
</pre></div>
</div>
</section>
<section id="haproxy">
<h3><span class="section-number">1.5.4. </span>haproxyの導入・設定<a class="headerlink" href="#haproxy" title="この見出しへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">以下の内容を <strong>ha-conf-haproxy-01</strong> および <strong>ha-conf-haproxy-02</strong> で実施します。</div>
<div class="line">※haproxyでSSL終端させるのでmakeコマンドにオプション追加（ <strong>USE_OPENSSL=1</strong> ）</div>
</div>
<ul class="simple">
<li><p>haproxyインストール</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>su<span class="w"> </span>-
dnf<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>gcc<span class="w"> </span>systemd-devel
curl<span class="w"> </span>-k<span class="w"> </span>https://www.haproxy.org/download/2.8/src/haproxy-2.8.3.tar.gz<span class="w"> </span>&gt;<span class="w"> </span>haproxy-2.8.3.tar.gz
tar<span class="w"> </span>zxf<span class="w"> </span>haproxy-2.8.3.tar.gz
<span class="nb">cd</span><span class="w"> </span>haproxy-2.8.3
make<span class="w"> </span>clean
make<span class="w"> </span>-j<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>linux-glibc<span class="w"> </span><span class="nv">USE_THREAD</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">USE_SYSTEMD</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">USE_OPENSSL</span><span class="o">=</span><span class="m">1</span>
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/^PREFIX = \/usr\/local/PREFIX = \/usr\/local\/haproxy/g&#39;</span><span class="w"> </span>Makefile
make<span class="w"> </span>install
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PATH=/usr/local/haproxy/sbin:$PATH&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile
.<span class="w"> </span>/etc/profile
</pre></div>
</div>
<ul class="simple">
<li><p>haproxyインストール確認</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>which<span class="w"> </span>haproxy
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-number">リスト 1.2 </span><span class="caption-text">結果</span><a class="headerlink" href="#id10" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/usr/local/haproxy/sbin/haproxy
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>haproxy.cfg の設定（haproxy起動確認用）</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>/etc/haproxy
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;__EOF__ &gt; /etc/haproxy/haproxy.cfg</span>
<span class="s">global</span>
<span class="s">    log         127.0.0.1 local2</span>

<span class="s">    chroot      /var/lib/haproxy</span>
<span class="s">    pidfile     /var/run/haproxy.pid</span>
<span class="s">    maxconn     4000</span>
<span class="s">    user        haproxy</span>
<span class="s">    group       haproxy</span>
<span class="s">    daemon</span>

<span class="s">    stats socket /var/lib/haproxy/stats</span>

<span class="s">defaults</span>
<span class="s">    mode                    http</span>
<span class="s">    log                     global</span>
<span class="s">    option                  httplog</span>
<span class="s">    option                  dontlognull</span>
<span class="s">    option http-server-close</span>
<span class="s">    option forwardfor       except 127.0.0.0/8</span>
<span class="s">    option                  redispatch</span>
<span class="s">    retries                 3</span>
<span class="s">    timeout http-request    10s</span>
<span class="s">    timeout queue           10s</span>
<span class="s">    timeout connect         10s</span>
<span class="s">    timeout client          10s</span>
<span class="s">    timeout server          10s</span>
<span class="s">    timeout http-keep-alive 10s</span>
<span class="s">    timeout check           10s</span>
<span class="s">    maxconn                 3000</span>

<span class="s">frontend main</span>
<span class="s">    bind *:5000</span>
<span class="s">    default_backend back</span>

<span class="s">backend back</span>
<span class="s">    balance    roundrobin</span>
<span class="s">    server     web1  &lt;&lt; self_IPAddress &gt;&gt;:80  check inter 5s rise 15 fall 1</span>

<span class="s">listen hastats</span>
<span class="s">    bind *:8080</span>
<span class="s">    mode http</span>
<span class="s">    stats enable</span>
<span class="s">    stats show-legends</span>
<span class="s">    stats uri /stats</span>
<span class="s">__EOF__</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; self_IPAddress &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM_SELF_IP_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>/etc/haproxy/haproxy.cfg
</pre></div>
</div>
<ul class="simple">
<li><p>haproxy起動設定</p></li>
</ul>
<div class="line-block">
<div class="line">アカウント・ディレクトリ作成</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>groupadd<span class="w"> </span>haproxy
useradd<span class="w"> </span>-g<span class="w"> </span>haproxy<span class="w"> </span>haproxy
id<span class="w"> </span>haproxy
mkdir<span class="w"> </span>/var/lib/haproxy
</pre></div>
</div>
<div class="line-block">
<div class="line">haproxy.serviceの作成</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;__EOF__ &gt; /etc/systemd/system/haproxy.service</span>
<span class="s">[Unit]</span>
<span class="s">Description=HAProxy Systemctl</span>
<span class="s">After=network.target</span>

<span class="s">[Service]</span>
<span class="s">Environment=&quot;CONFIG=/etc/haproxy/haproxy.cfg&quot;</span>
<span class="s">Environment=&quot;PIDFILE=/var/run/haproxy.pid&quot;</span>
<span class="s">ExecStartPre=/usr/local/haproxy/sbin/haproxy -f \$CONFIG -c</span>
<span class="s">ExecStart=/usr/local/haproxy/sbin/haproxy -Ws  -f \$CONFIG -p \$PIDFILE</span>
<span class="s">ExecReload=/usr/local/haproxy/sbin/haproxy -f \$CONFIG -c -q</span>
<span class="s">ExecReload=/bin/kill -USR2 \$MAINPID</span>
<span class="s">KillMode=mixed</span>
<span class="s">Restart=always</span>
<span class="s">SuccessExitStatus=143</span>
<span class="s">Type=notify</span>

<span class="s">[Install]</span>
<span class="s">WantedBy=multi-user.target</span>
<span class="s">__EOF__</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">service設定ファイル再読み込み</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>daemon-reload
</pre></div>
</div>
<div class="line-block">
<div class="line">haproxy起動・自動起動設定</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>start<span class="w"> </span>haproxy
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>haproxy
</pre></div>
</div>
<ul class="simple">
<li><p>haproxy起動確認</p></li>
</ul>
<div class="line-block">
<div class="line">プロセスの確認</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;[h]aproxy&#39;</span>
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-number">リスト 1.3 </span><span class="caption-text">結果</span><a class="headerlink" href="#id11" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>root<span class="w">       </span><span class="m">43658</span><span class="w">       </span><span class="m">1</span><span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">15</span>:00<span class="w"> </span>?<span class="w">        </span><span class="m">00</span>:00:00<span class="w"> </span>/usr/local/haproxy/sbin/haproxy<span class="w"> </span>-Ws<span class="w"> </span>-f<span class="w"> </span>/etc/haproxy/haproxy.cfg<span class="w"> </span>-p<span class="w"> </span>/var/run/haproxy.pid
haproxy<span class="w">    </span><span class="m">43660</span><span class="w">   </span><span class="m">43658</span><span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">15</span>:00<span class="w"> </span>?<span class="w">        </span><span class="m">00</span>:00:00<span class="w"> </span>/usr/local/haproxy/sbin/haproxy<span class="w"> </span>-Ws<span class="w"> </span>-f<span class="w"> </span>/etc/haproxy/haproxy.cfg<span class="w"> </span>-p<span class="w"> </span>/var/run/haproxy.pid
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line">httpdのインストール・起動</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dnf<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>httpd
systemctl<span class="w"> </span>start<span class="w"> </span>httpd
</pre></div>
</div>
<div class="line-block">
<div class="line">http接続確認</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">NO_PROXY</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_PROXY</span><span class="si">}</span>,<span class="si">${</span><span class="nv">VM_SELF_IP_ADDR</span><span class="si">}</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">no_proxy</span><span class="o">=</span><span class="si">${</span><span class="nv">no_proxy</span><span class="si">}</span>,<span class="si">${</span><span class="nv">VM_SELF_IP_ADDR</span><span class="si">}</span>

<span class="c1"># htmlの応答があること</span>
curl<span class="w"> </span><span class="si">${</span><span class="nv">VM_SELF_IP_ADDR</span><span class="si">}</span>:5000

<span class="c1"># htmlの応答があること</span>
curl<span class="w"> </span><span class="si">${</span><span class="nv">VM_SELF_IP_ADDR</span><span class="si">}</span>:80

<span class="c1"># エラーとなること</span>
curl<span class="w"> </span><span class="si">${</span><span class="nv">VM_SELF_IP_ADDR</span><span class="si">}</span>:100
</pre></div>
</div>
</section>
<section id="keepalived">
<h3><span class="section-number">1.5.5. </span>keepalived の導入<a class="headerlink" href="#keepalived" title="この見出しへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">以下の内容を <strong>ha-conf-haproxy-01</strong> および <strong>ha-conf-haproxy-02</strong> で実施します。</div>
</div>
<ul class="simple">
<li><p>Network Interface名の取得</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>route
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-number">リスト 1.4 </span><span class="caption-text">結果</span><a class="headerlink" href="#id12" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Destination<span class="w">     </span>Gateway<span class="w">         </span>Genmask<span class="w">         </span>Flags<span class="w"> </span>Metric<span class="w"> </span>Ref<span class="w">    </span>Use<span class="w"> </span>Iface
default<span class="w">         </span>_gateway<span class="w">        </span><span class="m">0</span>.0.0.0<span class="w">         </span>UG<span class="w">    </span><span class="m">100</span><span class="w">    </span><span class="m">0</span><span class="w">        </span><span class="m">0</span><span class="w"> </span>eth0
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line">結果からIfaceの値を後で使用するのでシェル変数に格納します。</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">KEEPALIVED_NIC_NAME</span><span class="o">=</span><span class="s2">&quot;eth0&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>keepalived のインストール</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dnf<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>keepalived
</pre></div>
</div>
<ul class="simple">
<li><dl class="simple">
<dt>keepalived.conf雛形ファイル作成 (ha-conf-haproxy-01)</dt><dd><p><strong>※ha-conf-haproxy-01で実施</strong></p>
</dd>
</dl>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;__EOF__ &gt; ~/keepalived.conf</span>
<span class="s">vrrp_instance VI_1 {</span>
<span class="s">    state MASTER</span>
<span class="s">    interface &lt;&lt; Iface名 &gt;&gt;</span>
<span class="s">    virtual_router_id 188</span>
<span class="s">    priority 100</span>
<span class="s">    advert_int 2</span>
<span class="s">    authentication {</span>
<span class="s">        auth_type PASS</span>
<span class="s">        auth_pass password</span>
<span class="s">    }</span>
<span class="s">    virtual_ipaddress {</span>
<span class="s">        &lt;&lt; virtual_IPAddress_1 &gt;&gt;/24 &lt;&lt; Iface名 &gt;&gt;</span>
<span class="s">    }</span>
<span class="s">    unicast_src_ip &lt;&lt; v2ha_lb1_IPAddress &gt;&gt;  \$ MASTER_IP_VALUE</span>
<span class="s">    unicast_peer {</span>
<span class="s">        &lt;&lt; v2ha_lb2_IPAddress &gt;&gt;  \$ BACKUP_IP_VALUE</span>
<span class="s">    }</span>
<span class="s">}</span>
<span class="s">__EOF__</span>
</pre></div>
</div>
<ul class="simple">
<li><dl class="simple">
<dt>keepalived.conf雛形ファイル作成 (ha-conf-haproxy-02)</dt><dd><p><strong>※ha-conf-haproxy-02で実施</strong></p>
</dd>
</dl>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;__EOF__ &gt; ~/keepalived.conf</span>
<span class="s">vrrp_instance VI_1 {</span>
<span class="s">    state BACKUP</span>
<span class="s">    interface &lt;&lt; Iface名 &gt;&gt;</span>
<span class="s">    virtual_router_id 188</span>
<span class="s">    priority 99</span>
<span class="s">    advert_int 2</span>
<span class="s">    authentication {</span>
<span class="s">        auth_type PASS</span>
<span class="s">        auth_pass password</span>
<span class="s">    }</span>
<span class="s">    virtual_ipaddress {</span>
<span class="s">        &lt;&lt; virtual_IPAddress_1 &gt;&gt;/24 &lt;&lt; Iface名 &gt;&gt;</span>
<span class="s">    }</span>
<span class="s">    unicast_src_ip &lt;&lt; v2ha_lb2_IPAddress &gt;&gt;  \$ BACKUP_IP_VALUE</span>
<span class="s">    unicast_peer {</span>
<span class="s">        &lt;&lt; v2ha_lb1_IPAddress &gt;&gt;  \$ MASTER_IP_VALUE</span>
<span class="s">    }</span>
<span class="s">}</span>
<span class="s">__EOF__</span>
</pre></div>
</div>
<ul class="simple">
<li><p>keepalived.confの修正</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; Iface名 &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">KEEPALIVED_NIC_NAME</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>~/keepalived.conf
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; virtual_IPAddress_1 &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">VIRTUAL_IP_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>~/keepalived.conf
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; v2ha_lb1_IPAddress &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM1_IP_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>~/keepalived.conf
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; v2ha_lb2_IPAddress &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM2_IP_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>~/keepalived.conf
</pre></div>
</div>
<ul class="simple">
<li><p>keepalived.confの設置・起動</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>-p<span class="w"> </span>/etc/keepalived/keepalived.conf<span class="w"> </span>/etc/keepalived/keepalived.conf.buk
cp<span class="w"> </span>~/keepalived.conf<span class="w"> </span>/etc/keepalived/keepalived.conf
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>keepalived
systemctl<span class="w"> </span>start<span class="w"> </span>keepalived
</pre></div>
</div>
<ul class="simple">
<li><p>keepalivedの起動確認</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;[k]eepalived&#39;</span>
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-number">リスト 1.5 </span><span class="caption-text">結果</span><a class="headerlink" href="#id13" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>root<span class="w">       </span><span class="m">45997</span><span class="w">       </span><span class="m">1</span><span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">10</span>:10<span class="w"> </span>?<span class="w">        </span><span class="m">00</span>:00:00<span class="w"> </span>/usr/sbin/keepalived<span class="w"> </span>-D
<span class="w"> </span>root<span class="w">       </span><span class="m">45998</span><span class="w">   </span><span class="m">45997</span><span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">10</span>:10<span class="w"> </span>?<span class="w">        </span><span class="m">00</span>:00:00<span class="w"> </span>/usr/sbin/keepalived<span class="w"> </span>-D
</pre></div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ip<span class="w"> </span>a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="si">${</span><span class="nv">KEEPALIVED_NIC_NAME</span><span class="si">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">※1号機にVIPが付与されていること</div>
</div>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-number">リスト 1.6 </span><span class="caption-text">結果</span><a class="headerlink" href="#id14" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2</span>:<span class="w"> </span>eth0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>fq_codel<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>inet<span class="w"> </span><span class="m">192</span>.168.0.2/24<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>dynamic<span class="w"> </span>noprefixroute<span class="w"> </span>eth0
<span class="w">    </span>inet<span class="w"> </span><span class="m">192</span>.168.0.1/24<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>secondary<span class="w"> </span>eth0
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-number">リスト 1.7 </span><span class="caption-text">結果</span><a class="headerlink" href="#id15" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2</span>:<span class="w"> </span>eth0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>fq_codel<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">      </span>inet<span class="w"> </span><span class="m">192</span>.168.0.3/24<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>dynamic<span class="w"> </span>noprefixroute<span class="w"> </span>eth0
</pre></div>
</div>
</div>
</section>
<section id="keepalived-haproxy">
<h3><span class="section-number">1.5.6. </span>アクセス確認(keepalived+haproxy)<a class="headerlink" href="#keepalived-haproxy" title="この見出しへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">NO_PROXY</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_PROXY</span><span class="si">}</span>,<span class="si">${</span><span class="nv">VIRTUAL_IP_ADDR</span><span class="si">}</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">no_proxy</span><span class="o">=</span><span class="si">${</span><span class="nv">no_proxy</span><span class="si">}</span>,<span class="si">${</span><span class="nv">VIRTUAL_IP_ADDR</span><span class="si">}</span>

<span class="c1"># htmlの応答があること</span>
curl<span class="w"> </span><span class="si">${</span><span class="nv">VIRTUAL_IP_ADDR</span><span class="si">}</span>:5000

<span class="c1"># htmlの応答があること</span>
curl<span class="w"> </span><span class="si">${</span><span class="nv">VIRTUAL_IP_ADDR</span><span class="si">}</span>:80

<span class="c1"># エラーとなること</span>
curl<span class="w"> </span><span class="si">${</span><span class="nv">VIRTUAL_IP_ADDR</span><span class="si">}</span>:100
</pre></div>
</div>
</section>
<section id="haproxy-ssl">
<h3><span class="section-number">1.5.7. </span>haproxy SSL化<a class="headerlink" href="#haproxy-ssl" title="この見出しへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">本手順では自己証明書でSSL化する例となります。</div>
<div class="line">（正規の認証局が発行した証明書を利用する場合は、正規の証明書を設定してください）</div>
</div>
<ul class="simple">
<li><p>自己証明書の作成</p></li>
</ul>
<div class="line-block">
<div class="line">以下の内容を <strong>ha-conf-haproxy-01</strong> で実施する</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/etc/pki/tls/certs
openssl<span class="w"> </span>genrsa<span class="w"> </span><span class="m">2048</span><span class="w"> </span>&gt;<span class="w"> </span>ha-conf-haproxy-server.key
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>ha-conf-haproxy-server.key<span class="w"> </span>&gt;<span class="w"> </span>ha-conf-haproxy-server.csr
</pre></div>
</div>
<div class="line-block">
<div class="line">必要な項目があれば入力、今回は入力項目は全てなし（enter）で行う。</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [XX]:
State or Province Name (full name) []:
Locality Name (eg, city) [Default City]:
Organization Name (eg, company) [Default Company Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (eg, your name or your server&#39;s hostname) []:
Email Address []:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openssl<span class="w"> </span>x509<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>-req<span class="w"> </span>-signkey<span class="w"> </span>ha-conf-haproxy-server.key<span class="w"> </span>&lt;<span class="w"> </span>ha-conf-haproxy-server.csr<span class="w"> </span>&gt;<span class="w"> </span>ha-conf-haproxy-server.crt
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>ha-conf-haproxy-server.crt<span class="w"> </span>ha-conf-haproxy-server.key<span class="w"> </span>&gt;<span class="w"> </span>ha-conf-haproxy-server.pem
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>ha-conf-haproxy-server.key<span class="w"> </span>ha-conf-haproxy-server.pem
</pre></div>
</div>
<ul class="simple">
<li><p>2号機に証明書を配置</p></li>
</ul>
<div class="line-block">
<div class="line">1号機に設置した <strong>ha-conf-haproxy-server.pem</strong> を２号機の/etc/pki/tls/certs配下に同様に配置</div>
</div>
<ul class="simple">
<li><p>haproxy.cfg変更</p></li>
</ul>
<p>以下の内容を <strong>ha-conf-haproxy-01</strong> および <strong>ha-conf-haproxy-02</strong> で実施する
haproxy.cfgを以下の内容で修正します</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vi<span class="w"> </span>/etc/haproxy/haproxy.cfg
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-number">リスト 1.8 </span><span class="caption-text">/etc/haproxy/haproxy.cfg（変更前）</span><a class="headerlink" href="#id16" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>frontend<span class="w"> </span>main
<span class="w">    </span><span class="nb">bind</span><span class="w"> </span>*:5000
<span class="w">    </span>default_backend<span class="w"> </span>back
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-number">リスト 1.9 </span><span class="caption-text">/etc/haproxy/haproxy.cfg（変更後）</span><a class="headerlink" href="#id17" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>frontend<span class="w"> </span>main
<span class="w">    </span><span class="nb">bind</span><span class="w">    </span>*:443<span class="w"> </span>ssl<span class="w"> </span>crt<span class="w"> </span>/etc/pki/tls/certs/ha-conf-haproxy-server.pem
<span class="w">    </span>mode<span class="w">    </span>http
<span class="w">    </span>option<span class="w"> </span>forwardfor
<span class="w">    </span>http-request<span class="w"> </span>add-header<span class="w"> </span>X-Forwarded-Proto<span class="w"> </span>https
<span class="w">    </span>default_backend<span class="w">  </span>back
</pre></div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>restart<span class="w"> </span>haproxy
</pre></div>
</div>
</section>
<section id="haproxy-exastro">
<h3><span class="section-number">1.5.8. </span>haproxy（exastro接続）<a class="headerlink" href="#haproxy-exastro" title="この見出しへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;__EOF__ &gt; /etc/haproxy/haproxy.cfg</span>
<span class="s">global</span>
<span class="s">    log         127.0.0.1 local2</span>

<span class="s">    chroot      /var/lib/haproxy</span>
<span class="s">    pidfile     /var/run/haproxy.pid</span>
<span class="s">    maxconn     4000</span>
<span class="s">    user        haproxy</span>
<span class="s">    group       haproxy</span>
<span class="s">    daemon</span>

<span class="s">    stats socket /var/lib/haproxy/stats</span>

<span class="s">    tune.maxrewrite         32000</span>
<span class="s">    tune.http.maxhdr        32000</span>
<span class="s">    tune.pattern.cache-size 0</span>

<span class="s">defaults</span>
<span class="s">    mode                    http</span>
<span class="s">    log                     global</span>
<span class="s">    option                  httplog</span>
<span class="s">    option                  dontlognull</span>
<span class="s">    # option http-server-close</span>
<span class="s">    option http-keep-alive</span>
<span class="s">    option forwardfor       except 127.0.0.0/8</span>
<span class="s">    option                  redispatch</span>
<span class="s">    retries                 3</span>
<span class="s">    timeout http-request    600s</span>
<span class="s">    timeout queue           600s</span>
<span class="s">    timeout connect         30s</span>
<span class="s">    timeout client          600s</span>
<span class="s">    timeout server          600s</span>
<span class="s">    timeout http-keep-alive 30s</span>
<span class="s">    timeout check           30s</span>
<span class="s">    maxconn                 3000</span>

<span class="s">frontend main</span>
<span class="s">    bind    *:443 ssl crt /etc/pki/tls/certs/ha-conf-haproxy-server.pem</span>
<span class="s">    mode    http</span>
<span class="s">    option forwardfor</span>
<span class="s">    http-request add-header X-Forwarded-Proto https</span>
<span class="s">    acl is_exastro_user  hdr_dom(host) -i &lt;&lt; v2ha_exastro_user_vhostname &gt;&gt;</span>
<span class="s">    acl is_exastro_admin hdr_dom(host) -i &lt;&lt; v2ha_exastro_admin_vhostname &gt;&gt;</span>
<span class="s">    use_backend user_backend  if is_exastro_user</span>
<span class="s">    use_backend admin_backend if is_exastro_admin</span>

<span class="s">backend user_backend</span>
<span class="s">    balance    roundrobin</span>
<span class="s">    server     node1  &lt;&lt; v2ha_k8s_node1_IPAddress &gt;&gt;:30080  check  inter 2s rise 2 fall 1</span>
<span class="s">    server     node2  &lt;&lt; v2ha_k8s_node2_IPAddress &gt;&gt;:30080  check  inter 2s rise 2 fall 1</span>
<span class="s">    server     node3  &lt;&lt; v2ha_k8s_node3_IPAddress &gt;&gt;:30080  check  inter 2s rise 2 fall 1</span>
<span class="s">backend admin_backend</span>
<span class="s">    balance    roundrobin</span>
<span class="s">    server     node-admin1  &lt;&lt; v2ha_k8s_node1_IPAddress &gt;&gt;:30081  check  inter 2s rise 2 fall 1</span>
<span class="s">    server     node-admin2  &lt;&lt; v2ha_k8s_node2_IPAddress &gt;&gt;:30081  check  inter 2s rise 2 fall 1</span>
<span class="s">    server     node-admin3  &lt;&lt; v2ha_k8s_node3_IPAddress &gt;&gt;:30081  check  inter 2s rise 2 fall 1</span>

<span class="s">listen hastats</span>
<span class="s">    bind *:8080</span>
<span class="s">    mode http</span>
<span class="s">    stats enable</span>
<span class="s">    stats show-legends</span>
<span class="s">    stats uri /stats</span>
<span class="s">__EOF__</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">アクセスする際のvirtual host名をシェル変数に格納します</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">EXASTRO_USER_VHOSTNAME</span><span class="o">=</span><span class="s2">&quot;exastro.ha-conf.local&quot;</span>
<span class="nv">EXASTRO_ADMIN_VHOSTNAME</span><span class="o">=</span><span class="s2">&quot;exastro-admin.ha-conf.local&quot;</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; v2ha_exastro_user_vhostname &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">EXASTRO_USER_VHOSTNAME</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>/etc/haproxy/haproxy.cfg
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; v2ha_exastro_admin_vhostname &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">EXASTRO_ADMIN_VHOSTNAME</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>/etc/haproxy/haproxy.cfg
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; v2ha_k8s_node1_IPAddress &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">K8S_NODE1_IP_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>/etc/haproxy/haproxy.cfg
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; v2ha_k8s_node2_IPAddress &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">K8S_NODE2_IP_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>/etc/haproxy/haproxy.cfg
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; v2ha_k8s_node3_IPAddress &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">K8S_NODE3_IP_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>/etc/haproxy/haproxy.cfg
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span>s/<span class="s2">&quot;&lt;&lt; self_IPAddress &gt;&gt;&quot;</span>/<span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM_SELF_IP_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>/g<span class="w"> </span>/etc/haproxy/haproxy.cfg
</pre></div>
</div>
</section>
<section id="exastro-external-url">
<h3><span class="section-number">1.5.9. </span>exastro EXTERNAL_URL設定変更<a class="headerlink" href="#exastro-external-url" title="この見出しへのパーマリンク">¶</a></h3>
<p>kubernetesノード（kubectlで接続可能な環境）に入り、以下を実施します。
※helm install時に既に設定している場合は不要</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>edit<span class="w"> </span>cm<span class="w"> </span>params-platform-auth<span class="w"> </span>-n<span class="w"> </span>exastro
</pre></div>
</div>
<p>以下に変更</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-number">リスト 1.10 </span><span class="caption-text">exastro.yaml</span><a class="headerlink" href="#id18" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="linenos">353</span><span class="w"> </span>platform-auth:
<span class="linenos">354</span><span class="w"> </span>  extraEnv:
<span class="linenos">355</span><span class="w"> </span>    # Please set the URL to access
<span class="linenos">356</span><span class="gd">-    EXTERNAL_URL: &quot;http:change-this.com&quot;</span>
<span class="linenos">357</span><span class="gd">-    EXTERNAL_URL_MNG: &quot;http:change-this.com&quot;</span>
<span class="linenos">358</span><span class="gi">+    EXTERNAL_URL: &quot;https://exastro.ha-conf.epoch-labo.local&quot;</span>
<span class="linenos">359</span><span class="gi">+    EXTERNAL_URL_MNG: &quot;https://exastro-admin.ha-conf.epoch-labo.local&quot;</span>
</pre></div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>helm<span class="w"> </span>upgrade<span class="w"> </span>exastro<span class="w"> </span>exastro/exastro<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>--namespace<span class="w"> </span>exastro<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>--values<span class="w"> </span>exastro.yaml
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h2><span class="section-number">1.6. </span>ストレージ<a class="headerlink" href="#id7" title="この見出しへのパーマリンク">¶</a></h2>
</section>
</section>


</div>


<div id="articleNavigation">
  <ul>
    <li class="prev"><a href="index.html" title="前のトピックへ"><span>前のトピックへ</span>ベストプラクティス</a></li>
    <li class="next"><a href="../../installation/index.html" title="次のトピックへ"><span>次のトピックへ</span>インストール</a></li>
  </ul>
</div>


<div id="pageTopLink">
  <a href="#container"><i>↑</i> Page Top</a>
</div>

</article>
</div>
</main>
</div><!-- End #contents -->
<div id="footer">
  <footer class="divInner">
    <small>Copyright © 2019-2023 NEC Corporation</small>
    <small><a href="/terms/ja.html">サイト規約</a></small>
  </footer>
</div><!-- End #footer -->

<div id="overlay"></div>
<div id="grayBack"></div>

</div><!-- End #container -->
  </body>
</html>